<!doctype html>
<meta charset="utf-8" />
<html>
<head>
    <title>Experiment</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-5.0.3/plugins/single-stim-quantis.js"></script>
    <script src="jspsych-5.0.3/plugins/single-stim-quantis2.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-text.js"></script>

    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>
<body>
</body>
<script>
    // ------------------------- EDIT THIS VARIABLES ------------------------------------
    // note that all file pathes are relative to the apache base directory which is normally
    // var/www/html
    // time is always in ms
    // text can be formatted with HTML text formatting elements like <p> <b> <mark> and so on
    // IMPORTANT! Firefox has problems with empty strings like ''. Try to fill all strings!
    // this behavior does not happen on Chromium

    // total number of trials
    var Ntrials1 = 100;
    var Ntrials2 = 200;
    var Ntrials3 = 300;
    var Ntrials4 = 400;
    // first text to show = welcome text
    var TEXT_WELCOME = "<p>Willkommen zum Experiment!</p>";
    // instruction immediately after the welcome text
    var TEXT_INSTRUCTION = "<p>Instruktion.</p>";
    var TEXT_STARTEXPERIMENT = "<p>Schieben Sie nun bitte den Mauszeiger zur Seite und drücken Sie eine beliebige Taste um mit der Darstellung der Bilder zu beginnen.</p>";
    // text after end of experiment

    // duration of fixation cross in ms
    var TIME_CROSS = 700;
    // duration of stimulus image
    var TIME_STIMULUS = 400;
    var TIME_STIMULUS_LANG = 2000;
    // delay after stimulus
    var TIME_POST_STIMULUS = 1100;
    
    // folder for saving data. 
	BASE_PATH = 'C:\\xampp\\htdocs\\data\\';

    // picture to use as fixation cross between trials
    var IM_FIXATION_CROSS = 'img/cross.png';

    // an array of paths to images for stimuli
    var images_social_A = ['img/INK/social/A1.jpg',
                    'img/INK/social/A2.jpg',
                    'img/INK/social/A3.jpg',
                    'img/INK/social/A4.jpg',
                    'img/INK/social/A5.jpg',
                    'img/INK/social/A6.jpg',
                    'img/INK/social/A7.jpg',
                    'img/INK/social/A8.jpg',
                    'img/INK/social/A9.jpg',
                    'img/INK/social/A10.jpg',
                    'img/INK/social/A11.jpg',
                    'img/INK/social/A12.jpg',
                    'img/INK/social/A13.jpg',
                    'img/INK/social/A14.jpg',
                    'img/INK/social/A15.jpg',
                    'img/INK/social/A16.jpg',
                    'img/INK/social/A17.jpg',
                    'img/INK/social/A18.jpg',
                    'img/INK/social/A19.jpg',
                    'img/INK/social/A20.jpg'];
    
    var images_social_B = ['img/INK/social/B1.jpg',
                    'img/INK/social/B2.jpg',
                    'img/INK/social/B3.jpg',
                    'img/INK/social/B4.jpg',
                    'img/INK/social/B5.jpg',
                    'img/INK/social/B6.jpg',
                    'img/INK/social/B7.jpg',
                    'img/INK/social/B8.jpg',
                    'img/INK/social/B9.jpg',
                    'img/INK/social/B10.jpg',
                    'img/INK/social/B11.jpg',
                    'img/INK/social/B12.jpg',
                    'img/INK/social/B13.jpg',
                    'img/INK/social/B14.jpg',
                    'img/INK/social/B15.jpg',
                    'img/INK/social/B16.jpg',
                    'img/INK/social/B17.jpg',
                    'img/INK/social/B18.jpg',
                    'img/INK/social/B19.jpg',
                    'img/INK/social/B20.jpg'];

    var images_self_A = ['img/INK/self/A1.png',
                    'img/INK/self/A2.png',
                    'img/INK/self/A3.png',
                    'img/INK/self/A4.png',
                    'img/INK/self/A5.png',
                    'img/INK/self/A6.png',
                    'img/INK/self/A7.png',
                    'img/INK/self/A8.png',
                    'img/INK/self/A9.png',
                    'img/INK/self/A10.png',
                    'img/INK/self/A11.png',
                    'img/INK/self/A12.png',
                    'img/INK/self/A13.png',
                    'img/INK/self/A14.png',
                    'img/INK/self/A15.png',
                    'img/INK/self/A16.png',
                    'img/INK/self/A17.png',
                    'img/INK/self/A18.png',
                    'img/INK/self/A19.png',
                    'img/INK/self/A20.png'];
    
    var images_self_B = ['img/INK/self/B1.png',
                    'img/INK/self/B2.png',
                    'img/INK/self/B3.png',
                    'img/INK/self/B4.png',
                    'img/INK/self/B5.png',
                    'img/INK/self/B6.png',
                    'img/INK/self/B7.png',
                    'img/INK/self/B8.png',
                    'img/INK/self/B9.png',
                    'img/INK/self/B10.png',
                    'img/INK/self/B11.png',
                    'img/INK/self/B12.png',
                    'img/INK/self/B13.png',
                    'img/INK/self/B14.png',
                    'img/INK/self/B15.png',
                    'img/INK/self/B16.png',
                    'img/INK/self/B17.png',
                    'img/INK/self/B18.png',
                    'img/INK/self/B19.png',
                    'img/INK/self/B20.png'];
    
    var images_pleasure_A = ['img/INK/pleasure/A1.jpg',
                    'img/INK/pleasure/A2.jpg',
                    'img/INK/pleasure/A3.jpg',
                    'img/INK/pleasure/A4.jpg',
                    'img/INK/pleasure/A5.jpg',
                    'img/INK/pleasure/A6.jpg',
                    'img/INK/pleasure/A7.jpg',
                    'img/INK/pleasure/A8.jpg',
                    'img/INK/pleasure/A9.jpg',
                    'img/INK/pleasure/A10.jpg',
                    'img/INK/pleasure/A11.jpg',
                    'img/INK/pleasure/A12.jpg',
                    'img/INK/pleasure/A13.jpg',
                    'img/INK/pleasure/A14.jpg',
                    'img/INK/pleasure/A15.jpg',
                    'img/INK/pleasure/A16.jpg',
                    'img/INK/pleasure/A17.jpg',
                    'img/INK/pleasure/A18.jpg',
                    'img/INK/pleasure/A19.jpg',
                    'img/INK/pleasure/A20.jpg'];
    
    var images_pleasure_B = ['img/INK/pleasure/B1.jpg',
                    'img/INK/pleasure/B2.jpg',
                    'img/INK/pleasure/B3.jpg',
                    'img/INK/pleasure/B4.jpg',
                    'img/INK/pleasure/B5.jpg',
                    'img/INK/pleasure/B6.jpg',
                    'img/INK/pleasure/B7.jpg',
                    'img/INK/pleasure/B8.jpg',
                    'img/INK/pleasure/B9.jpg',
                    'img/INK/pleasure/B10.jpg',
                    'img/INK/pleasure/B11.jpg',
                    'img/INK/pleasure/B12.jpg',
                    'img/INK/pleasure/B13.jpg',
                    'img/INK/pleasure/B14.jpg',
                    'img/INK/pleasure/B15.jpg',
                    'img/INK/pleasure/B16.jpg',
                    'img/INK/pleasure/B17.jpg',
                    'img/INK/pleasure/B18.jpg',
                    'img/INK/pleasure/B19.jpg',
                    'img/INK/pleasure/B20.jpg'];
    
    var images_control_A = ['img/INK/control/A1.jpg',
                    'img/INK/control/A2.jpg',
                    'img/INK/control/A3.jpg',
                    'img/INK/control/A4.jpg',
                    'img/INK/control/A5.jpg',
                    'img/INK/control/A6.jpg',
                    'img/INK/control/A7.jpg',
                    'img/INK/control/A8.jpg',
                    'img/INK/control/A9.jpg',
                    'img/INK/control/A10.jpg',
                    'img/INK/control/A11.jpg',
                    'img/INK/control/A12.jpg',
                    'img/INK/control/A13.jpg',
                    'img/INK/control/A14.jpg',
    //                'img/INK/control/A15.jpg',
    //                'img/INK/control/A16.jpg',
    //                'img/INK/control/A17.jpg',
    //                'img/INK/control/A18.jpg',
    //                'img/INK/control/A19.jpg',
                    'img/INK/control/A15.jpg'];
    


    var images_cross = [
            'img/8.png',
            'img/14.png',
            'img/cross.png'];

 //   var images_cross_rnd = jsPsych.randomization.repeat(images_cross, Math.floor(Ntrials / images_cross.length) + 1);

    // ------------------------- END VARIABLE BLOCK ------------------------------------
 // Random ID
    var subject_id = jsPsych.randomization.randomID(8);
    
    var datetime = new Date();
    
    var filename = 'INK ' +
		datetime.getFullYear() +'.'+datetime.getMonth()+1+'.'+datetime.getDate()+' '+
		datetime.getHours() +'.' + datetime.getMinutes()+
		' ' + subject_id;
            // add id and datetime to data. each file line will contain this information
            jsPsych.data.addProperties({
                time : datetime,
                subject_id: subject_id
            });
    console.log('subject id = ' + subject_id );
    
    // current trial number
    var i_trial = 0;

   // var repeats = Math.floor(Ntrials / images_A.length);
   // images_A = jsPsych.randomization.repeat(images_A, repeats);
   // images_B = jsPsych.randomization.repeat(images_B, repeats);
      
      images_social_A = jsPsych.randomization.sample(images_social_A, Ntrials1, true);
      images_social_B = jsPsych.randomization.sample(images_social_B, Ntrials1, true);
      images_self_A = jsPsych.randomization.sample(images_self_A, Ntrials1, true);
      images_self_B = jsPsych.randomization.sample(images_self_B, Ntrials1, true);
      images_pleasure_A = jsPsych.randomization.sample(images_pleasure_A, Ntrials1, true);
      images_pleasure_B = jsPsych.randomization.sample(images_pleasure_B, Ntrials1, true);
      images_control_A = jsPsych.randomization.sample(images_control_A, Ntrials1, true);
      images_control_B = jsPsych.randomization.sample(images_control_A, Ntrials1, true);
    
    var images_social = {stim_A: images_social_A, stim_B: images_social_B};
    var images_self = {stim_A: images_self_A, stim_B: images_self_B};
    var images_pleasure = {stim_A: images_pleasure_A, stim_B: images_pleasure_B};
    var images_control = {stim_A: images_control_A, stim_B: images_control_B};
    

    var welcomeinstructions_block = {
    type: 'instructions',
    pages: [
        TEXT_WELCOME,
        TEXT_INSTRUCTION
    ],
    show_clickable_nav: true,
    timing_post_trial: 500
};
    
    /* define start experiment block */
    var startexperiment_block = {
        type: "text",
        text: TEXT_STARTEXPERIMENT,
        timing_post_trial: 500
    };


    jsPsych.pluginAPI.preloadImages(images_social_A, function () {
    }, function () {
        console.log('loading So A images...')
    });
    jsPsych.pluginAPI.preloadImages(images_social_B, function () {
    }, function () {
        console.log('loading So B images...')
    });
    jsPsych.pluginAPI.preloadImages(images_self_A, function () {
    }, function () {
        console.log('loading Se A images...')
    });
    jsPsych.pluginAPI.preloadImages(images_self_B, function () {
    }, function () {
        console.log('loading Se B images...')
    });
    jsPsych.pluginAPI.preloadImages(images_pleasure_A, function () {
    }, function () {
        console.log('loading Pl A images...')
    });
    jsPsych.pluginAPI.preloadImages(images_pleasure_B, function () {
    }, function () {
        console.log('loading Pl B images...')
    });
    jsPsych.pluginAPI.preloadImages(images_control_A, function () {
    }, function () {
        console.log('loading Co A images...')
    });
    jsPsych.pluginAPI.preloadImages(images_control_B, function () {
        startExperiment();
    }, function () {
        console.log('loading Co B images...')
    });

//  var im = [images_A, images_B];

    /* define test block */
    var test_stimuli_social = [
        {
            stimulus: images_social,
            data: {}
        }
    ];
    var test_stimuli_self = [
        {
            stimulus: images_self,
            data: {}
        }
    ];
    var test_stimuli_pleasure = [
        {
            stimulus: images_pleasure,
            data: {}
        }
    ];
    var test_stimuli_control = [
        {
            stimulus: images_control,
            data: {}
        }
    ];

    var get_cross_or_number = function(){
        return images_cross_rnd[i_trial]
    }

    var intertrial = {
        type: 'single-stim',
        stimulus: IM_FIXATION_CROSS,
//        stimulus: get_cross_or_number,
        is_html: false,
        timing_response: TIME_CROSS,
        timing_post_trial: 0,
        response_ends_trial: false    };

    var test_block_social = {
        type: "single-stim-quantis",
        choices: 'none',

        timing_stim: TIME_STIMULUS,
        timing_response: TIME_STIMULUS,
        timing_post_trial: TIME_POST_STIMULUS,

        stimuli: images_social,

        i_trial: function(){return i_trial}, // current trial modulo number of images
        on_finish: function (data) {
            jsPsych.data.addDataToLastTrial(
                    {   trial_number: i_trial
                    });
            i_trial++;
        },

        timeline: test_stimuli_social
    };

    var test_block_self = {
        type: "single-stim-quantis",
        choices: 'none',

        timing_stim: TIME_STIMULUS,
        timing_response: TIME_STIMULUS,
        timing_post_trial: TIME_POST_STIMULUS,

        stimuli: images_self,

        i_trial: function(){return i_trial}, // current trial modulo number of images
        on_finish: function (data) {
            jsPsych.data.addDataToLastTrial(
                    {   trial_number: i_trial
                    });
            i_trial++;
        },

        timeline: test_stimuli_self
    };
    
    var test_block_pleasure = {
        type: "single-stim-quantis",
        choices: 'none',

        timing_stim: TIME_STIMULUS,
        timing_response: TIME_STIMULUS,
        timing_post_trial: TIME_POST_STIMULUS,

        stimuli: images_pleasure,

        i_trial: function(){return i_trial}, // current trial modulo number of images
        on_finish: function (data) {
            jsPsych.data.addDataToLastTrial(
                    {   trial_number: i_trial
                    });
            i_trial++;
        },

        timeline: test_stimuli_pleasure
    };
    
    var test_block_control = {
        type: "single-stim-quantis2",
        choices: 'none',

        timing_stim: TIME_STIMULUS_LANG,
        timing_response: TIME_STIMULUS,
        timing_post_trial: TIME_POST_STIMULUS,

        stimuli: images_control,

        i_trial: function(){return i_trial}, // current trial modulo number of images
        on_finish: function (data) {
            jsPsych.data.addDataToLastTrial(
                    {   trial_number: i_trial
                    });
            i_trial++;
        },

        timeline: test_stimuli_control
    };
    
   var save_block = {
    type: 'single-stim',
    stimulus: 'saving data',
    is_html: true,
    timing_response: 100,
    response_ends_trial: false,
    on_finish:  function (data) {
                saveData('data/ink/' + filename + '.csv', jsPsych.data.dataAsCSV())
            }
    };

    var debrief_block = {
        type: "text",
        text: "<p>Vielen Dank!</p><p><a href='https://www.soscisurvey.de/isst/?r=" + subject_id + "'>Klicken Sie bitte hier, um einige abschließende Fragen zu beantworten</a></p>",
        cont_key: '?'
    };


    /* create experiment timeline array */
    var timeline = [];
    timeline.push(welcomeinstructions_block);
    timeline.push(startexperiment_block);
    for(var i=0; i < Ntrials1; i++){
      timeline.push(intertrial); // add a fixation trial
      timeline.push(test_block_social); // add a word trial
    }
    for(var i=Ntrials1; i < Ntrials2; i++){
      timeline.push(intertrial); // add a fixation trial
      timeline.push(test_block_social); // add a word trial
    }
    for(var i=Ntrials2; i < Ntrials3; i++){
      timeline.push(intertrial); // add a fixation trial
      timeline.push(test_block_social); // add a word trial
    }
    for(var i=Ntrials3; i < Ntrials4; i++){
      timeline.push(intertrial); // add a fixation trial
      timeline.push(test_block_social); // add a word trial
    }
    timeline.push(save_block);
    timeline.push(debrief_block);

    function saveData(filename, filedata) {
        console.log("starting save data...", filename, filedata);
        $.ajax({
            type: 'post',
            cache: false,
            url: 'save-data.php', // this is the path to the above PHP script
            data: {filename: filename, filedata: filedata}
        })
                .done(function (data) {
                    // alert("OK OK OK" + data)
                })
                .fail(function () {
                    alert("Ajax failed to send data")
                });
        console.log("finished save data");
    }

    /* start the experiment */
    function startExperiment() {
        jsPsych.init({
            timeline: timeline,
            fullscreen: true
        });
    }
</script>
</html>
